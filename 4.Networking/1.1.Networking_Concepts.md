# Azure Networking Concepts: VNets, Subnets, NSGs, ASGs, CIDR, and Route Tables

## Virtual Networks (VNets)

An **Azure Virtual Network (VNet)** is a logically isolated private network in Azure, dedicated to your subscription.  It represents your on-premises network in the cloud and lets you define IP address spaces, DNS settings, and security policies.  All Azure resources (VMs, databases, etc.) that you want to communicate privately must be deployed within a VNet.  By default, every VNet is isolated from other VNets and from on-premises networks; you can connect VNets to each other only via explicit peering, VPNs, or ExpressRoute connections.

**Key points:**

* VNets span an Azure region (multiple availability zones) and use private IPv4/IPv6 address ranges (CIDR blocks) you specify.  For example, `10.0.0.0/16` yields 65,536 addresses.  Azure reserves 5 addresses in each subnet for internal use.
* VNets are used to segment Azure workloads.  You can deploy separate VNets for development, testing, and production, or for different departments (e.g. a banking app VNet vs a data analytics VNet).
* **Finance use case:** A financial institution might create a VNet for payment processing and another VNet for analytics.  These act as trust boundaries: by default they cannot communicate unless peered or connected through a secured gateway (e.g. ExpressRoute), in line with compliance requirements for isolating sensitive workloads.

**Example (Azure CLI):** Create a VNet with address space 10.0.0.0/16:

```bash
az network vnet create -g FinanceRG -n ProductionVNet --address-prefix 10.0.0.0/16
```

This command creates `ProductionVNet` in resource group `FinanceRG` with a /16 CIDR block (65,536 addresses).

## Subnets

A **subnet** is a contiguous range of IP addresses within a VNet.  Each subnet partitions the VNet’s address space and isolates groupings of resources.  For example, you might have a subnet for web servers and another for databases within the same VNet.  Azure reserves the first and last IP addresses in each subnet and three more for its own use (so a /24 subnet has 256 addresses but 251 usable).

> *“A subnet is a range of IP addresses in the virtual network. You can divide a virtual network into multiple subnets for organization and security… NICs connected to subnets (same or different) within a VNet can communicate with each other without any extra configuration.”*.

**Key points:**

* Subnets allow you to group resources by tier or function (e.g. *FrontendSubnet*, *AppSubnet*, *DbSubnet*).  They are often sized using CIDR (see below).
* **No automatic security boundary:** By default, VMs in different subnets **can** talk to each other.  Azure does **not** enforce isolation between subnets unless you apply security controls.
* To enforce isolation or filtering, you attach **Network Security Groups (NSGs)** or **service appliances** to subnets or to the NICs of VMs (see below).

**Finance use case:** A bank may use subnets to isolate tiers of a trading application: e.g. a subnet for externally-facing web front-end servers, a subnet for internal application servers, and a subnet for sensitive database servers.  Even though these subnets live in the same VNet, NSGs and routing will control which subnets can talk to which, meeting regulatory network segmentation needs.

## Network Security Groups (NSGs)

A **Network Security Group (NSG)** is a firewall-like access-control container in Azure.  An NSG contains a list of security rules that allow or deny inbound and outbound network traffic based on source/destination IP, port, and protocol.  You can associate an NSG with one or more subnets and/or individual NICs.  When applied to a subnet, the NSG rules govern all VMs in that subnet (unless those VMs’ NICs have their own NSG).

> *“Use an Azure network security group (NSG) to filter network traffic to and from Azure resources in an Azure virtual network. A network security group contains security rules that allow or deny inbound network traffic to, or outbound network traffic from, \[Azure resources].”*.

**How NSGs work:**

* **Rules:** Each rule specifies source IP/CIDR (or service tag/ASG), source port, destination IP/CIDR (or ASG), dest port, protocol, direction (in/out), and allow/deny.  Lower priority numbers are processed first. Azure includes default rules (e.g. *DenyAllInbound* for internet) so you generally create explicit allow rules.
* **Evaluation Order:** For inbound packets, Azure first applies the NSG on the subnet (if any) then the NSG on the VM’s NIC (if any).  For outbound, NIC NSG is evaluated before subnet NSG.
* **Stateful:** NSGs are stateful, so if outbound traffic is allowed, the return traffic is automatically allowed.

**Example rule:** Allow HTTP inbound from the Internet:

```bash
az network nsg rule create -g FinanceRG --nsg-name ProdNSG -n AllowHTTPInternet \
  --priority 100 --direction Inbound --access Allow --protocol Tcp \
  --source-address-prefix Internet --destination-port-range 80
```

This creates an NSG rule in `ProdNSG` allowing port 80 from any Internet IP (with priority 100).

**Finance use case:** A network admin for a trading system might create NSG rules like:

* *Allow database access only from the application subnet:* source = AppSubnet range, dest = DbSubnet, port = 1433 (MSSQL) – all other database traffic is denied by default.
* *Block RDP from the public Internet:* Deny RDP (port 3389) unless from a secure jump-box.
  These rules enforce **least-privilege** access, e.g. only allowing approved system components to talk, which is critical for compliance (PCI DSS, FFIEC, etc.).

## Application Security Groups (ASGs)

An **Application Security Group (ASG)** is a logical grouping of VM network interfaces within a VNet.  Instead of writing NSG rules that refer to IP addresses, you can assign NICs (or VMs) to one or more ASGs (e.g. *WebTierASG*, *DbTierASG*) and write rules that refer to these groups.  This makes rules easier to manage at scale.

> *“Application security groups in Azure Virtual Network enable you to configure network security as a natural extension of an application’s structure, allowing you to group virtual machines and define network security policies based on those groups. You can reuse your security policy at scale without manual maintenance of explicit IP addresses.”*.

**Key points:**

* An ASG itself has no security rules.  It is used **only** as a source or destination in NSG rules.  For example, an NSG rule can say “allow TCP 80 from *ASG=WebTier* to *ASG=AppTier*”.
* NICs can belong to multiple ASGs, and ASGs exist within one VNet (they cannot span VNets).  When you scale out VMs, just add their NICs to the appropriate ASGs. NSG rules immediately apply without rewriting IP-based rules.
* **Ease of management:** ASGs decouple rule authoring from static IP lists. For instance, if the web tier VMs are in ASG “WebTier”, a single rule `source: WebTier` will cover them all, even as the underlying IPs change.

**Example (Azure CLI):** Create an ASG and use it in an NSG rule:

```bash
az network asg create -g FinanceRG --vnet-name ProductionVNet -n WebTierASG

az network nsg rule create -g FinanceRG --nsg-name ProdNSG -n AllowWebTraffic \
  --priority 110 --direction Inbound --access Allow --protocol Tcp \
  --source-asg WebTierASG --destination-port-range 80
```

This creates an ASG named `WebTierASG` and an NSG rule that allows TCP port 80 **to** any resource in `WebTierASG` from the Internet (assuming source-asg is set to a tag like `Internet`).

**Finance use case:** A bank’s app tier might consist of many microservices.  Rather than IP-based rules, you group all front-end VMs into an ASG “WebServers” and back-end VMs into “AppServers”. Then NSG rules can cleanly say “allow 443 from WebServers to AppServers” or “deny all inbound to AppServers from Internet” without listing IPs.  This simplifies adherence to policies that require isolating application layers.

## Comparison: NSG vs ASG

| Feature                 | Network Security Group (NSG)                                         | Application Security Group (ASG)                                                                           |
| ----------------------- | -------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------- |
| **Role/Definition**     | Firewall-like container of security rules (allows/denies traffic)    | Logical grouping of NICs/VMs (no rules) for use in NSGs                                                    |
| **Contains**            | Explicit access rules (source/dest/port/protocol)                    | No rules – just a tag on VMs/NICs that can be used in NSG rules                                            |
| **Scope**               | Applies to entire subnets or individual NICs                         | Applies only within a single VNet (cannot span VNets)                                                      |
| **Usage**               | Controls traffic flow (network ACL) at layer 3–4                     | Simplifies NSG rule management by grouping VMs by function                                                 |
| **References in rules** | Source/Dest can be IP, CIDR, service tag, or ASG (after creation)    | Used as source or dest in NSG rules (e.g. Allow from ASG-Web to ASG-App)                                   |
| **Typical application** | Enforce allow/deny policies (e.g. “allow port 3389 from corp IPs”)   | Tag VMs for NSG rules (e.g. group all SQL servers into “DbGroup”)                                          |
| **Financial example**   | An NSG rule: “allow TCP 1433 from ASG BusinessApps to ASG DBServers” | Group all business-logic VMs under `BusinessApps` ASG, DB VMs under `DBServers` ASG to simplify such rules |

## CIDR Notation

**CIDR (Classless Inter-Domain Routing)** is how Azure defines IP address ranges for VNets and subnets.  A CIDR block like `10.0.0.0/16` means the first 16 bits of the address are fixed (here `10.0.*.*`), yielding 2^(32−16)=65,536 possible IPs.  Subnet sizes are also specified in CIDR (e.g. a `/24` is 256 IPs).  The CIDR suffix (e.g. `/24`) determines the subnet mask.

> *“CIDR (Classless Inter-Domain Routing) is a method for allocating IP addresses. It’s the `/x` number, and that number determines how many IP addresses will be available in that subnet.”*

**Key points:**

* When creating a VNet or subnet, you specify a CIDR range (e.g. `10.1.0.0/24`).  The portal shows how many IPs that covers.  For example, `/24` has 256 addresses, but Azure **reserves 5** for each subnet (the first for network ID, the last for broadcast, plus 3 for Azure services), leaving 251 usable.
* Choose CIDR carefully to avoid overlap with on-prem networks or peer VNets.  Overlapping ranges will prevent peering or VPN connectivity.
* **Example:** A `/29` subnet has 8 IPs total, but only 3 usable after reservations.  This minimal size might be used for a small service. In contrast, a `/24` allows up to 251 usable VMs.

**Finance planning:** A bank might use a large CIDR for its core VNet (e.g. `10.0.0.0/16`) to accommodate many subnets, then carve out smaller `/24` or `/26` subnets for each application tier or office location.  Care is taken to reserve space for growth and to avoid conflicts with on-premises branches.

## Route Tables (User-Defined Routes)

Azure automatically creates system routes so that resources can talk within a VNet, to peered VNets, on-premises, and the internet.  A **Route Table** (also called a User-Defined Route, UDR) lets you override these defaults by specifying custom routes for a subnet.  Each route has a destination prefix (CIDR) and a next hop (e.g. Virtual Network gateway, Internet, Virtual Appliance).

> *“Azure automatically routes traffic between Azure subnets, virtual networks, and on-premises networks. If you want to change Azure’s default routing, you do so by creating a route table.”*

**Key points:**

* You attach a route table to one or more subnets.  All VMs in those subnets inherit the table’s routes (in addition to Azure’s default routes).
* **Common routes:** For example, an IT architect might add a route `0.0.0.0/0 → VirtualAppliance (10.0.0.4)` to send all internet-bound traffic through a firewall VM at 10.0.0.4.  Another example is `192.168.1.0/24 → VNet Peering` to send traffic to a specific peered VNet.
* Azure also supports BGP route propagation via VPN or ExpressRoute gateways, allowing on-premises routes to be learned and used in the VNet (bypassing manual entry).

**Example (Azure CLI):** Create a route table that directs all outbound traffic to a firewall appliance:

```bash
az network route-table create -g FinanceRG -n SecureRT

az network route-table route create -g FinanceRG --route-table-name SecureRT -n ForceFirewall \
  --address-prefix 0.0.0.0/0 --next-hop-type VirtualAppliance --next-hop-ip 10.0.0.4

az network vnet subnet update -g FinanceRG --vnet-name ProductionVNet \
  -n FrontendSubnet --route-table SecureRT
```

This makes a route table `SecureRT` with one route sending all addresses (`0.0.0.0/0`) to 10.0.0.4 (a firewall VM).  The last command associates it to the subnet `FrontendSubnet`, causing all outbound traffic from that subnet to flow via the firewall.

**Finance use case:** Financial regulations often mandate inspection of outbound data.  By using a route table to forward traffic through an **NVA (Network Virtual Appliance)** or Azure Firewall (a specialized managed firewall service), a bank can ensure logging and filtering of all internet access.  Similarly, UDRs can implement forced tunneling of traffic through on-premises security stacks when ExpressRoute is used, so that in the event of a cloud breach the “blast radius” is minimized.

## Summary and Best Practices

* **Design VNets** with non-overlapping CIDR blocks, segmented into subnets for different tiers or departments.  In finance, treat VNets as strong trust boundaries between different business units or security zones.
* **Use NSGs** on every subnet (and possibly on NICs) to enforce least-privilege.  For example, “Allow only port 22 from corporate office IPs” or “Allow DB port 1433 only from AppSubnet”.  Remember that default NSG rules *deny* most inbound traffic.
* **Use ASGs** to group VMs by role.  This reduces the need to rewrite NSG rules whenever IPs change.  E.g. all payment-service VMs in one ASG, all analytics VMs in another. Then NSGs can simply allow or deny traffic between these groups.
* **Plan CIDR carefully:** Larger prefixes (e.g. /16) allow many hosts; smaller (e.g. /29) conserve space. Azure reserves 5 IPs per subnet, so always subtract 5 when calculating usable addresses.
* **Apply custom routes** via Route Tables to meet regulatory routing needs.  For instance, in finance you might route all outbound traffic through an approved firewall or on-premises proxy.  Use BGP route propagation where appropriate for hybrid connectivity.

These concepts together let you build a secure, segmented network in Azure. By combining VNets, subnets, NSGs, ASGs, CIDR planning, and route tables, a finance organization can enforce strict security controls (filtering traffic, isolating sensitive systems, logging flows) while still enabling necessary connectivity (to other VNets, on-premises, and the Internet).

**Comparison: NSG vs. ASG (in brief):** An NSG is the set of rules (like a firewall) that applies to subnets/VMs, whereas an ASG is just a label grouping NICs so that those rules can refer to named application tiers instead of raw IPs.

